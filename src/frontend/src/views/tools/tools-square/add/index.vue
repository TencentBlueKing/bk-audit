<!--
  TencentBlueKing is pleased to support the open source community by making
  蓝鲸智云 - 审计中心 (BlueKing - Audit Center) available.
  Copyright (C) 2023 THL A29 Limited,
  a Tencent company. All rights reserved.
  Licensed under the MIT License (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at http://opensource.org/licenses/MIT
  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on
  an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
  either express or implied. See the License for the
  specific language governing permissions and limitations under the License.
  We undertake not to change the open source license (MIT license) applicable
  to the current version of the project delivered to anyone in the future.
-->
<template>
  <skeleton-loading
    v-if="!isCreating && !isFailed && !isSuccessful"
    fullscreen
    :loading="loading || isEditDataLoading"
    name="createTools">
    <smart-action
      class="create-tools-page"
      :offset-target="getSmartActionOffsetTarget">
      <div class="create-tools-main">
        <audit-form
          ref="formRef"
          class="tools-form"
          form-type="vertical"
          :model="formData"
          :rules="rules">
          <card-part-vue :title="t('基础信息')">
            <template #content>
              <div class="flex-center">
                <bk-form-item
                  class="is-required mr16"
                  :label="t('工具名称')"
                  label-width="160"
                  property="name"
                  required
                  style="flex: 1;">
                  <bk-input
                    v-model.trim="formData.name"
                    :maxlength="32"
                    :placeholder="t('请输入，32字符内，可由汉字、小写字母、数字、“_”组成')"
                    show-word-limit
                    style="width: 100%;" />
                </bk-form-item>
                <bk-form-item
                  :label="t('工具标签')"
                  label-width="160"
                  property="tags"
                  style="flex: 1;">
                  <bk-loading
                    :loading="tagLoading"
                    style="width: 100%;">
                    <bk-select
                      v-model="formData.tags"
                      allow-create
                      class="bk-select"
                      filterable
                      :input-search="false"
                      multiple
                      multiple-mode="tag"
                      :placeholder="t('请选择')"
                      :search-placeholder="t('请输入关键字')">
                      <bk-option
                        v-for="(item, index) in allTagData"
                        :key="index"
                        :label="item.tag_name"
                        :value="item.tag_id" />
                    </bk-select>
                  </bk-loading>
                </bk-form-item>
              </div>
              <bk-form-item
                :label="t('工具说明')"
                label-width="160"
                property="description"
                required>
                <bk-input
                  v-model.trim="formData.description"
                  autosize
                  :maxlength="100"
                  :placeholder="t('请输入说明')"
                  show-word-limit
                  style="width: 50%;"
                  type="textarea" />
              </bk-form-item>
            </template>
          </card-part-vue>
          <!-- 工具类型 -->
          <card-part-vue :title="t('工具类型')">
            <template #content>
              <bk-form-item
                :label="t('工具类型')"
                label-width="160"
                property="tool_type"
                required>
                <bk-radio-group v-model="formData.tool_type">
                  <template
                    v-for="(item, index) in toolTypeList"
                    :key="index">
                    <bk-radio
                      :disabled="item.id === 'api' || route.name === 'toolsEdit'"
                      :label="item.id">
                      <div style="display: flex; align-items: center; line-height: 16px;">
                        <audit-icon
                          style=" margin-right: 5px;font-size: 16px;"
                          svg
                          :type="iconMap[item.id as keyof typeof iconMap]" />
                        <span
                          v-bk-tooltips="{
                            disabled: !item.tips,
                            content: item.tips || '',
                          }"
                          :style="item.tips ? { 'border-bottom': '1px dashed #979ba5' } : {}">{{ item.name }}</span>
                      </div>
                    </bk-radio>
                  </template>
                </bk-radio-group>
              </bk-form-item>
              <!-- 数据查询 -->
              <template v-if="formData.tool_type === 'data_search'">
                <bk-form-item
                  :label="t('配置方式')"
                  label-width="160"
                  property="data_search_config_type"
                  required>
                  <bk-button-group>
                    <bk-button
                      v-for="item in searchTypeList"
                      :key="item.value"
                      :disabled="item.disabled"
                      :selected="formData.data_search_config_type === item.value"
                      @click="() => formData.data_search_config_type = item.value">
                      {{ item.label }}
                    </bk-button>
                  </bk-button-group>
                  <div>
                    <bk-tag v-if="formData.data_search_config_type === 'simple'">
                      {{ t('用于复杂的 SQL 查询，先编写 SQL，再根据 SQL 内的结果与变量配置前端样式') }}
                    </bk-tag>
                    <bk-tag v-else>
                      {{ t('用于单一数据表，先配置的输入与输出字段，默认生成查询语句') }}
                    </bk-tag>
                  </div>
                </bk-form-item>
                <bk-form-item
                  v-if="formData.data_search_config_type === 'simple'"
                  :label="t('选择数据源')"
                  label-width="160"
                  property="source"
                  required>
                  <bk-input
                    v-model="formData.source"
                    :placeholder="t('请输入数据源名称、表名、ID 等，或可直接按分类筛选')" />
                </bk-form-item>
              </template>
              <!-- bkvision 图表 -->
              <div v-else-if="formData.tool_type === 'bk_vision'">
                <bk-form-item
                  :label="t('选择报表')"
                  label-width="160"
                  property="config.uid"
                  required>
                  <div v-if="hasPermission">
                    <bk-cascader
                      v-model="configUid"
                      children-key="share"
                      id-key="uid"
                      :list="Array.isArray(chartLists) ? chartLists : []"
                      :multiple="false"
                      :show-complete-name="false"
                      :style="spacePermission ? `width: 50%;border: 1px solid #e71818;` : `width: 50%;`"
                      trigger="click"
                      @change="handleSpaceChange" />
                    <div
                      v-if="spacePermission"
                      class="permission">
                      {{ t('该报表无权限，请') }} <span
                        class="permission-link"
                        @click="handleApplyPermission">{{ t('申请权限') }}</span>
                    </div>
                  </div>
                  <div v-else>
                    <bk-input
                      disabled
                      :model-value="t('当前图表你没有权限，请申请权限后再操作')" />
                  </div>
                </bk-form-item>
              </div>
            </template>
          </card-part-vue>
          <component
            :is="ToolTypeComMap[formData.tool_type]"
            ref="comRef"
            :data-search-config-type="formData.data_search_config_type"
            :name="formData.name"
            :uid="formData.uid" />
        </audit-form>
      </div>
      <template #action>
        <bk-button
          class="w88"
          theme="primary"
          @click="handleSubmit">
          {{ isEditMode ? t('提交') : t('创建') }}
        </bk-button>
        <bk-button
          class="ml8"
          @click="handleCancel">
          {{ t('取消') }}
        </bk-button>
        <!-- <bk-button
          class="ml8"
          :disabled="!formData.config.sql"
          style="margin-left: 48px;"
          @click="handlePreview">
          {{ t('预览测试') }}
        </bk-button> -->
      </template>
    </smart-action>
  </skeleton-loading>
  <creating
    v-if="isCreating"
    :is-edit-mode="isEditMode" />
  <failed
    v-if="isFailed"
    :is-edit-mode="isEditMode"
    :name="formData.name"
    @modify-again="handleModifyAgain" />
  <successful
    v-if="isSuccessful"
    :is-edit-mode="isEditMode"
    :name="formData.name" />
</template>

<script setup lang='tsx'>
  import _ from 'lodash';
  import { nextTick, onMounted, ref, watch } from 'vue';
  import { useI18n } from 'vue-i18n';
  import { useRoute, useRouter } from 'vue-router';

  import MetaManageService from '@service/meta-manage';
  import RootManageService from '@service/root-manage';
  import ToolManageService from '@service/tool-manage';

  import ConfigModel from '@model/root/config';
  import ToolDetailModel from '@model/tool/tool-detail';

  import useRouterBack from '@hooks/use-router-back';

  import BkVision from './components/bkvision/index.vue';
  import CardPartVue from './components/card-part.vue';
  import DataSearch from './components/data-search/index.vue';
  import Creating from './components/tool-status/creating.vue';
  import Failed from './components/tool-status/failed.vue';
  import Successful from './components/tool-status/Successful.vue';

  // import useMessage from '@/hooks/use-message';
  import useRequest from '@/hooks/use-request';


  interface FormData {
    uid?: string; // 工具uid
    source?:string;
    users?: string[];
    name: string;
    tags: string[];
    description: string;
    tool_type: string;
    data_search_config_type: string;
    config: {
      referenced_tables: Array<{
        table_name: string | null;
        alias: string | null;
        permission: {
          result: boolean;
        };
      }>;
      input_variable: Array<{
        raw_name: string;
        display_name: string;
        description: string;
        required: boolean;
        field_category: string;
        default_value: string | Array<string>;
        choices: Array<{
          key: string,
          name: string
        }>
      }>
      output_fields: Array<{
        raw_name: string;
        display_name: string;
        description: string;
        drill_config: {
          tool: {
            uid: string;
            version: number;
          };
          config: Array<{
            source_field: string;
            target_value_type: string;
            target_value: string;
          }>
        };
        enum_mappings: {
          collection_id: string;
          mappings: Array<{
            key: string;
            name: string;
          }>;
        };
      }>
      sql: string;
      uid: string;
    };
  }

  interface ChartListModel {
    uid: string;
    name: string;
    share: Array<{
      uid: string;
      name: string;
    }>;
  }

  const searchTypeList = [{
    label: '简易模式',
    value: 'simple',
    disabled: true,
  }, {
    label: 'SQL模式',
    value: 'sql',
  }];

  const ToolTypeComMap: Record<string, any> = {
    data_search: DataSearch,
    bk_vision: BkVision,
  };

  const route = useRoute();
  const router = useRouter();
  const { t } = useI18n();

  const isEditMode = route.name === 'toolsEdit';

  const configUid = ref<string[]>([]);
  const hasPermission = ref(true);
  const spacePermission = ref(false);

  const formRef = ref();
  const comRef = ref();

  const loading = ref(false);
  const isCreating = ref(false);
  const isFailed = ref(false);
  const isSuccessful = ref(false);

  const allTagMap = ref<Record<string, string>>({});

  const formData = ref<FormData>({
    source: '',
    users: [],
    name: '',
    tags: [],
    description: '',
    tool_type: 'data_search',
    data_search_config_type: 'sql',
    config: {
      referenced_tables: [],
      input_variable: [{
        raw_name: '',
        display_name: '',
        description: '',
        required: false,
        field_category: '',
        default_value: '',
        choices: [],
      }],
      output_fields: [{
        raw_name: '',
        display_name: '',
        description: '',
        drill_config: {
          tool: {
            uid: '',
            version: 1,
          },
          config: [],
        },
        enum_mappings: {
          collection_id: '',
          mappings: [],
        },
      }],
      sql: '',
      uid: '',  // bkvision图表uid
    },
  });

  const allTagData = ref<Array<{
    tag_id: string
    tag_name: string;
  }>>([]);

  const toolTypeList = ref<Array<{
    id: string;
    name: string;
    tips?: string;
  }>>([{
    id: 'data_search',
    name: t('数据查询'),
    tips: t('根据输入条件，使用 SQL 查询数据库以获得结果；可定义输入与输出'),
  }, {
    id: 'api',
    name: t('API接口'),
    tips: t('暂未开放，敬请期待'),
  }, {
    id: 'bk_vision',
    name: t('bkvision图表'),
  }]);

  const iconMap = {
    data_search: 'sqlxiao',
    api: 'apixiao',
    bk_vision: 'bkvisonxiao',
  };

  const getSmartActionOffsetTarget = () => document.querySelector('.create-tools-page');

  const rules = {
    tags: [
      // 因为校验的是name，但value是id的数组；将item转为name，自定义输入id = name，直接使用item即可
      {
        validator: (value: Array<string>) => {
          const reg = /^[\w\u4e00-\u9fa5-_]+$/;
          return value.every(item => reg.test(allTagMap.value[item] ? allTagMap.value[item] : item));
        },
        message: t('标签只允许中文、字母、数字、中划线或下划线组成'),
        trigger: 'change',
      },
      {
        validator: (value: Array<string>) => {
          const reg = /\D+/;
          return value.every(item => reg.test(allTagMap.value[item] ? allTagMap.value[item] : item));
        },
        message: t('标签不能为纯数字'),
        trigger: 'change',
      },
    ],
  };

  const {
    data: configData,
  } = useRequest(RootManageService.config, {
    defaultValue: new ConfigModel(),
    manual: true,
  });

  // 获取所有标签列表
  const {
    loading: tagLoading,
  } = useRequest(MetaManageService.fetchTags, {
    defaultValue: [],
    manual: true,
    onSuccess: (data) => {
      allTagData.value = data.reduce((res, item) => {
        if (item.tag_id !== '-2') {
          res.push({
            tag_id: item.tag_id,
            tag_name: item.tag_name,
          });
        }
        return res;
      }, [] as Array<{
        tag_id: string;
        tag_name: string
      }>);
      data.forEach((item) => {
        allTagMap.value[item.tag_id] = item.tag_name;
      });
    },
  });

  // 获取图表列表
  const {
    data: chartLists,
    run: fetchChartLists,
  } = useRequest(ToolManageService.fetchChartLists, {
    defaultValue: new Array<ChartListModel>(),
    // manual: true,
    onSuccess: (data) => {
      if (data === 'error') {
        hasPermission.value = false;
        chartLists.value = [];
        return;
      }
      if (isEditMode) {
        if (Array.isArray(data)) {
          hasPermission.value = true;
          configUid.value = data.map((item: any) => {
            let ids = '';
            item.share.forEach((sh: any) => {
              if (sh.uid === formData.value.config.uid) {
                ids = `${item.uid},${sh.uid}`;
              }
            });
            return ids;
          }).filter(item => item !== '')[0].split(',');
        }
      }
    },
  });

  const {
    run: fetchReportLists,
  } = useRequest(ToolManageService.fetchReportLists, {
    defaultValue: {},
    onSuccess: (res) => {
      if (res) {
        const configInputVariable = _.cloneDeep(formData.value.config.input_variable);

        const { panels, variables } = res.data;
        const filters = [...new Set(Object.keys(res.filters))];


        formData.value.config.input_variable = filters
          .map((item) => {
            const com = panels.find((p:any) => p.uid === item);
            // 如果找不到对应的组件，返回 null，后续过滤掉
            if (!com) {
              return null;
            }

            // 在编辑模式下，查找原有的 default_value
            let originalDefaultValue: string | Array<string>  = '';
            if (isEditMode && configInputVariable.length > 0) {
              const originalItem = configInputVariable.find((original: any) => original.description === com.uid);
              if (originalItem) {
                originalDefaultValue = originalItem.default_value;
              }
            }

            return {
              raw_name: com?.chartConfig?.flag || '',
              display_name: com.title || '',
              description: com.uid || '',
              field_category: com.type || '',
              required: true,
              default_value: isEditMode ? originalDefaultValue : (com.value || ''),
              choices: [],
            };
          })
          .filter((item): item is NonNullable<typeof item> => item !== null); // 类型安全的过滤

        if (variables.length > 0) {
          variables.forEach((com: any) => {
            // 内置变量不处理,
            if (com.build_in) {
              return;
            }
            // 此input_variable 是 bkvision 图表的变量 配置下钻时才显示
            formData.value.config.input_variable.push({
              raw_name: com.flag,
              display_name: com.description || '',
              description: com.description || '',
              field_category: com.type || '',
              required: true,
              default_value: '',
              choices: [],
            });
          });
        }
        // 设置组件配置
        nextTick(() => {
          comRef.value.setConfigs(formData.value.config.input_variable);
        });
      } else {
        spacePermission.value = true;
      }
    },
  });

  // 选择报表
  const handleSpaceChange = (val: string) => {
    spacePermission.value = false;
    if (val.length === 0) {
      return;
    }
    formData.value.config.uid = val[val.length - 1];

    fetchReportLists({
      share_uid: val[val.length - 1],
    });
  };

  // 编辑状态获取数据
  const {
    run: fetchToolsDetail,
    loading: isEditDataLoading,
  } = useRequest(ToolManageService.fetchToolsDetail, {
    defaultValue: new ToolDetailModel(),
    onSuccess: (data) => {
      formData.value = data;
      comRef.value.setConfigs(formData.value.config);
    },
  });

  const handleApplyPermission = () => {
    window.open(`${configData.value.tool.vision_share_permission_url}`);
  };

  const handleCancel = () => {
    router.push({
      name: 'toolsSquare',
    });
  };

  const handleModifyAgain = () => {
    isCreating.value = false;
    isFailed.value = false;
    isSuccessful.value = false;
  };

  // 提交
  const handleSubmit = () => {
    const tastQueue = [formRef.value.validate()];
    if (comRef.value) {
      tastQueue.push(comRef.value.getValue());
    }

    Promise.all(tastQueue).then(() => {
      isCreating.value = true;

      const data = _.cloneDeep(formData.value);
      // 获取组件配置
      if (comRef.value.getFields) {
        if (data.tool_type === 'bk_vision') {
          console.log(comRef.value.getFields());
          data.config.input_variable = comRef.value.getFields();
        } else {
          data.config = comRef.value.getFields();
        }
      }
      const service = isEditMode ? ToolManageService.updateTool : ToolManageService.createTool;

      if (data.tags) {
        data.tags = data.tags.map(item => (allTagMap.value[item] ? allTagMap.value[item] : item));
      }
      console.log(data);
      service(data)
        .then(() => {
          isFailed.value = false;
          isSuccessful.value = true;
        })
        .catch(() => {
          isSuccessful.value = false;
          isFailed.value = true;
        })
        .finally(() => {
          isCreating.value = false;
        });
    });
  };

  watch(() => formData.value.tool_type, (val) => {
    if (val === 'bk_vision') {
      fetchChartLists();
    }
  });

  onMounted(() => {
    if (isEditMode) {
      fetchToolsDetail({
        uid: route.params.id,
      });
    }
  });

  useRouterBack(() => {
    router.push({
      name: 'toolsSquare',
    });
  });
</script>
<style lang="postcss" scoped>
.create-tools-page {
  .flex-center {
    display: flex;
    align-items: center;
  }

  .permission {
    font-size: 12px;
    color: #e71818;

    .permission-link {
      color: #3a84ff;
      cursor: pointer;
    }
  }
}

</style>
